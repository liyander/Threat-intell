'use client';

import React, { useEffect, useState, use } from 'react';
import { useRouter } from 'next/navigation';
import axios from 'axios';
import { ArrowLeft, Shield, File, Calendar, Tag, Activity, Bug, Server, Hash, Download } from 'lucide-react';
import { Badge } from 'lucide-react';

const LOADING_FACTS = [
    "Over 450,000 new malware samples are registered every day.",
    "Ransomware attacks occur every 11 seconds globally.",
    "Did you know? 94% of malware is delivered via email attachments.",
    "The average time to identify a data breach is 207 days.",
    "Polymorphic malware constantly changes its code signature to evade detection.",
    "The first computer virus, 'Creeper', was created in 1971 as an experiment.",
    "Mobile malware attacks have surged by 500% in recent years.",
    "Analyzing heuristics and behavioral patterns is key to detecting zero-day threats.",
    "Botnets like Mirai can hijack millions of IoT devices for DDoS attacks."
];

export default function MalwareDetailPage({ params }: { params: Promise<{ hash: string }> }) {
    const { hash } = use(params);
    const router = useRouter();
    
    const [data, setData] = useState<any>(null);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState<string | null>(null);
    const [factIndex, setFactIndex] = useState(0);

    // Rotate facts while loading
    useEffect(() => {
        if (!loading) return;
        const interval = setInterval(() => {
            setFactIndex(prev => (prev + 1) % LOADING_FACTS.length);
        }, 2500);
        return () => clearInterval(interval);
    }, [loading]);

    useEffect(() => {
        const fetchDetails = async () => {
             setLoading(true);
             // Artificial delay to let user see at least one cool fact if network is too fast
             const start = Date.now();
             
             try {
                 const res = await axios.get(`http://localhost:3001/api/threats/malware/${hash}`);
                 
                 // Ensure at least 1.5s of loading so UI doesn't flicker
                 const elapsed = Date.now() - start;
                 if (elapsed < 1500) await new Promise(r => setTimeout(r, 1500 - elapsed));

                 if(res.data.success) {
                     setData(res.data.data);
                 } else {
                     setError("Malware sample not found.");
                 }
             } catch (e) {
                 console.error("Failed to load malware details", e);
                 setError("Failed to load details. Check backend connection.");
             } finally {
                 setLoading(false);
             }
        };

        if (hash) {
            fetchDetails();
        }
    }, [hash]);

    if (loading) {
        return (
            <div className="min-h-screen bg-[#020617] flex flex-col items-center justify-center text-slate-400 p-4">
                <div className="w-full max-w-md bg-slate-900/50 border border-slate-800 rounded-lg p-8 relative overflow-hidden backdrop-blur-sm">
                    {/* Scanning Animation Line */}
                    <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-red-500 to-transparent animate-scan"></div>
                    
                    <div className="flex flex-col items-center gap-6 z-10 relative">
                        <div className="relative">
                            <div className="w-16 h-16 border-4 border-slate-800 rounded-full"></div>
                            <div className="absolute top-0 left-0 w-16 h-16 border-4 border-red-500 border-t-transparent rounded-full animate-spin"></div>
                            <Bug className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-red-500/50" size={24} />
                        </div>
                        
                        <div className="text-center space-y-2">
                            <h2 className="text-lg font-mono font-bold text-white tracking-widest uppercase animate-pulse">
                                Analyzing Artifact
                            </h2>
                            <p className="text-xs font-mono text-slate-500 truncate max-w-[300px] mx-auto opacity-70">
                                Hash: {hash}
                            </p>
                        </div>
                        
                        <div className="w-full bg-black/40 p-4 rounded border border-slate-800/50 min-h-[80px] flex items-center justify-center">
                            <p key={factIndex} className="text-sm text-center text-cyan-400 font-medium animate-pulse">
                                "{LOADING_FACTS[factIndex]}"
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        );
    }

    if (error || !data) {
        return (
             <div className="min-h-screen bg-[#020617] p-8 text-slate-300">
                 <button onClick={() => router.back()} className="flex items-center gap-2 mb-4 hover:text-white">
                     <ArrowLeft size={18} /> Back
                 </button>
                 <div className="p-4 border border-red-900/50 bg-red-900/20 rounded text-red-200">
                     {error || "Unknown error occurred."}
                 </div>
             </div>
        );
    }

    return (
        <div className="min-h-screen h-auto bg-[#020617] text-slate-300 p-6 font-sans overflow-y-auto">
            {/* Nav */}
            <button 
                onClick={() => router.back()}
                className="flex items-center gap-2 mb-6 hover:text-white transition-colors text-slate-400"
            >
                <ArrowLeft size={18} /> Back to Dashboard
            </button>

            <div className="max-w-7xl mx-auto">
                {/* Header */}
                <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8 border-b border-slate-800 pb-6">
                    <div>
                        <div className="flex items-center gap-3 mb-2">
                            <Bug className="text-red-500" size={32} />
                            <h1 className="text-2xl font-bold text-white tracking-tight break-all font-mono">{data.fileName || data.sha256}</h1>
                            <span className="px-3 py-1 bg-red-900/30 text-red-400 border border-red-900/50 rounded text-xs uppercase font-bold tracking-wider">
                                {data.signature !== 'Unknown' ? data.signature : 'Malware'}
                            </span>
                        </div>
                        <div className="flex gap-4 text-xs font-mono text-slate-500">
                             <span>First Seen: {new Date(data.firstSeen).toLocaleString()}</span>
                             <span>•</span>
                             <span>Platform: {data.platform}</span>
                             <span>•</span>
                             <span>Type: {data.fileType}</span>
                        </div>
                    </div>
                </div>

                {/* Main Content Grid */}
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    
                    {/* Left Column: hashes & Basic Info */}
                    <div className="lg:col-span-2 space-y-6">
                        
                         {/* Hashes Card */}
                        <section className="bg-slate-900/50 border border-slate-800 rounded-lg p-6">
                            <h3 className="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                                <Hash size={18} /> Cryptographic Identity
                            </h3>
                            <div className="space-y-3">
                                <div className="group">
                                    <label className="text-xs text-slate-500 uppercase font-bold">SHA256</label>
                                    <div className="font-mono text-xs text-cyan-400 break-all bg-black/30 p-2 rounded border border-slate-800/50 select-all">
                                        {data.sha256}
                                    </div>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                     <div>
                                        <label className="text-xs text-slate-500 uppercase font-bold">SHA1</label>
                                        <div className="font-mono text-xs text-slate-400 break-all bg-black/30 p-2 rounded border border-slate-800/50 select-all">
                                            {data.sha1}
                                        </div>
                                     </div>
                                     <div>
                                        <label className="text-xs text-slate-500 uppercase font-bold">MD5</label>
                                        <div className="font-mono text-xs text-slate-400 break-all bg-black/30 p-2 rounded border border-slate-800/50 select-all">
                                            {data.md5}
                                        </div>
                                     </div>
                                </div>
                                {data.imphash && (
                                     <div>
                                        <label className="text-xs text-slate-500 uppercase font-bold">Imphash</label>
                                        <div className="font-mono text-xs text-orange-400/80 break-all bg-black/30 p-2 rounded border border-slate-800/50 select-all">
                                            {data.imphash}
                                        </div>
                                     </div>
                                )}
                            </div>
                        </section>

                        {/* Intelligence */}
                        {data.vendorIntel && (
                             <section className="bg-slate-900/50 border border-slate-800 rounded-lg p-6">
                                <h3 className="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                                    <Activity size={18} /> Vendor Intelligence
                                </h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                     {/* VirusTotal */}
                                     {data.vendorIntel.VT && (
                                         <div className="bg-black/20 p-4 rounded border border-slate-800">
                                             <h4 className="text-sm font-bold text-slate-300 mb-2">VirusTotal</h4>
                                             <div className="flex items-center gap-3">
                                                 <span className={`text-xl font-bold ${data.vendorIntel.VT.score >= 10 ? 'text-red-500' : 'text-yellow-500'}`}>
                                                     {data.vendorIntel.VT.score}
                                                 </span>
                                                 <span className="text-xs text-slate-500">Detections</span>
                                             </div>
                                         </div>
                                     )}
                                      {/* Triage */}
                                     {data.vendorIntel.Triage && (
                                         <div className="bg-black/20 p-4 rounded border border-slate-800">
                                             <h4 className="text-sm font-bold text-slate-300 mb-2">Triage</h4>
                                             <div className="flex items-center gap-3">
                                                 <span className="text-sm text-slate-400">{data.vendorIntel.Triage.tags ? data.vendorIntel.Triage.tags.length : 0} Tags</span>
                                                  <span className="text-xs text-slate-500">Score: {data.vendorIntel.Triage.score || 'N/A'}</span>
                                             </div>
                                         </div>
                                     )}
                                </div>
                             </section>
                        )}
                        
                        {/* Behavioral Analysis (Triage) */}
                        {data.vendorIntel?.Triage?.signatures && data.vendorIntel.Triage.signatures.length > 0 && (
                            <section className="bg-slate-900/50 border border-slate-800 rounded-lg p-6">
                                <h3 className="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                                    <Activity size={18} /> Behavioral Signatures
                                </h3>
                                <div className="space-y-2">
                                    {data.vendorIntel.Triage.signatures.map((sig: any, i: number) => (
                                        <div key={i} className="flex justify-between items-start bg-black/20 p-2 rounded border border-slate-800/50">
                                            <span className="text-sm text-slate-300">{sig.signature}</span>
                                            <span className={`text-xs font-bold px-2 py-0.5 rounded ${parseInt(sig.score) > 7 ? 'bg-red-900/40 text-red-400' : 'bg-yellow-900/40 text-yellow-500'}`}>
                                                {sig.score}
                                            </span>
                                        </div>
                                    ))}
                                </div>
                            </section>
                        )}

                        {/* YARA Rules */}
                        {data.yaraRules && data.yaraRules.length > 0 && (
                            <section className="bg-slate-900/50 border border-slate-800 rounded-lg p-6">
                                <h3 className="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                                    <File size={18} /> YARA Matches
                                </h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    {data.yaraRules.map((rule: any, i: number) => (
                                        <div key={i} className="bg-black/20 p-3 rounded border border-slate-800/50 hover:border-slate-700 transition-colors">
                                            <p className="text-sm font-mono text-cyan-400 font-bold mb-1">{rule.rule_name}</p>
                                            <p className="text-xs text-slate-500">Author: {rule.author || 'Unknown'}</p>
                                            {rule.description && (
                                                <p className="text-xs text-slate-400 mt-2 italic">"{rule.description}"</p>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </section>
                        )}
                    </div>
                     
                    {/* Right Column: Metadata */}
                    <div className="space-y-6">
                        
                        {/* External Analysis Links */}
                        {data.vendorIntel && (
                             <section className="bg-slate-900/50 border border-slate-800 rounded-lg p-6">
                                <h3 className="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                                    <Server size={18} /> Deep Analysis
                                </h3>
                                <div className="space-y-2">
                                     {data.vendorIntel.Intezer?.analysis_url && (
                                         <a href={data.vendorIntel.Intezer.analysis_url} target="_blank" rel="noopener noreferrer" 
                                            className="block bg-blue-900/20 hover:bg-blue-900/40 border border-blue-900/50 p-3 rounded text-sm text-blue-300 transition-colors flex justify-between items-center group">
                                             <span>Intezer Gene Analysis</span>
                                             <Download size={14} className="group-hover:translate-x-1 transition-transform" />
                                         </a>
                                     )}
                                     {data.vendorIntel.Triage?.link && (
                                         <a href={data.vendorIntel.Triage.link} target="_blank" rel="noopener noreferrer" 
                                            className="block bg-orange-900/20 hover:bg-orange-900/40 border border-orange-900/50 p-3 rounded text-sm text-orange-300 transition-colors flex justify-between items-center group">
                                             <span>Triage Sandbox Report</span>
                                             <Download size={14} className="group-hover:translate-x-1 transition-transform" />
                                         </a>
                                     )}
                                     {data.vendorIntel['FileScan-IO']?.report_link && (
                                         <a href={data.vendorIntel['FileScan-IO'].report_link} target="_blank" rel="noopener noreferrer" 
                                            className="block bg-purple-900/20 hover:bg-purple-900/40 border border-purple-900/50 p-3 rounded text-sm text-purple-300 transition-colors flex justify-between items-center group">
                                             <span>FileScan.IO Report</span>
                                             <Download size={14} className="group-hover:translate-x-1 transition-transform" />
                                         </a>
                                     )}
                                      {data.vendorIntel.Kaspersky?.report_link && (
                                         <a href={data.vendorIntel.Kaspersky.report_link} target="_blank" rel="noopener noreferrer" 
                                            className="block bg-green-900/20 hover:bg-green-900/40 border border-green-900/50 p-3 rounded text-sm text-green-300 transition-colors flex justify-between items-center group">
                                             <span>Kaspersky Threat Intel</span>
                                             <Download size={14} className="group-hover:translate-x-1 transition-transform" />
                                         </a>
                                     )}
                                </div>
                            </section>
                        )}

                         {/* Tags */}
                         <section className="bg-slate-900/50 border border-slate-800 rounded-lg p-6">
                            <h3 className="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                                <Tag size={18} /> Artifact Tags
                            </h3>
                            <div className="flex flex-wrap gap-2">
                                {data.tags.map((tag: string, i: number) => (
                                    <span key={i} className="px-2 py-1 bg-slate-800 text-slate-300 border border-slate-700 rounded text-xs">
                                        {tag}
                                    </span>
                                ))}
                            </div>
                        </section>

                        {/* File Info */}
                        <section className="bg-slate-900/50 border border-slate-800 rounded-lg p-6">
                            <h3 className="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                                <File size={18} /> File Metadata
                            </h3>
                            <ul className="space-y-3 text-sm">
                                <li className="flex justify-between border-b border-slate-800 pb-2">
                                    <span className="text-slate-500">Size</span>
                                    <span className="font-mono">{data.fileSize} bytes</span>
                                </li>
                                <li className="flex justify-between border-b border-slate-800 pb-2">
                                    <span className="text-slate-500">Type</span>
                                    <span>{data.fileType}</span>
                                </li>
                                <li className="flex justify-between border-b border-slate-800 pb-2">
                                    <span className="text-slate-500">MIME</span>
                                    <span>{data.mimeType}</span>
                                </li>
                                <li className="flex justify-between pt-1">
                                    <span className="text-slate-500">Reporter</span>
                                    <span className="text-cyan-400">@{data.reporter}</span>
                                </li>
                            </ul>
                        </section>

                    </div>


                </div>
            </div>
        </div>
    );
}
