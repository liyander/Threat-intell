const axios = require('axios');
const NodeCache = require('node-cache');

const cache = new NodeCache({ stdTTL: 300 }); // 5 min cache

const fs = require('fs');

class MalwareBazaarService {
    constructor() {
        this.apiKey = 'b5d985fc19d88b867e49433b42a09a86c92baec7367eb5e8';
        this.baseUrl = 'https://mb-api.abuse.ch/api/v1/';
    }

    async getRecentMalware() {
        try {
            const cacheKey = 'malware_bazaar_recent';
            // Disable cache for debugging
            // if (cache.get(cacheKey)) return cache.get(cacheKey);

            // API expects form-urlencoded body
            const params = new URLSearchParams();
            params.append('query', 'get_recent');
            params.append('selector', '100'); // Get last 100

            const response = await axios.post(this.baseUrl, params, {
                headers: {
                    'Auth-Key': this.apiKey, // API-KEY or Auth-Key supported, trying Auth-Key
                    'Content-Type': 'application/x-www-form-urlencoded'
                }
            });


            if (response.data.query_status === 'ok') {
                const data = response.data.data.map(item => ({
                    sha256: item.sha256_hash,
                    fileName: item.file_name,
                    fileType: item.file_type,
                    mimeType: item.file_type_mime,
                    signature: item.signature || 'Unknown',
                    tags: item.tags || [],
                    reporter: item.reporter,
                    firstSeen: item.first_seen_utc,
                    deliveryMethod: item.delivery_method,
                    intelligence: item.intelligence,
                    platform: this.guessPlatform(item.file_type, item.tags)
                }));
                
                cache.set(cacheKey, data);
                return data;
            } else {
                console.error('Malware Bazaar API Error:', response.data.query_status);
                return [];
            }   
        } catch (error) {
            const fs = require('fs');
            // Log error to file
            try { fs.appendFileSync('malware_debug.log', `Error: ${error.message}\n`); } catch(e) {}
            console.error('Malware Bazaar Fetch Error:', error.message);
            return [];
        }
    }

    async getMalwareDetails(hash) {
        try {
            const params = new URLSearchParams();
            params.append('query', 'get_info');
            params.append('hash', hash);

            const response = await axios.post(this.baseUrl, params, {
                headers: {
                    'Auth-Key': this.apiKey,
                    'Content-Type': 'application/x-www-form-urlencoded'
                }
            });

            if (response.data.query_status === 'ok') {
                const item = response.data.data[0];
                return {
                    sha256: item.sha256_hash,
                    md5: item.md5_hash,
                    sha1: item.sha1_hash,
                    fileName: item.file_name,
                    fileType: item.file_type,
                    mimeType: item.file_type_mime,
                    signature: item.signature || 'Unknown',
                    tags: item.tags || [],
                    reporter: item.reporter,
                    firstSeen: item.first_seen_utc,
                    lastSeen: item.last_seen_utc,
                    deliveryMethod: item.delivery_method,
                    intelligence: item.intelligence,
                    platform: this.guessPlatform(item.file_type, item.tags),
                    fileSize: item.file_size,
                    ssdeep: item.ssdeep,
                    imphash: item.imphash,
                    yaraRules: item.yara_rules,
                    vendorIntel: item.vendor_intel // Contains VirusTotal etc
                };
            }
            return null;
        } catch (error) {
            console.error('Malware Details Fetch Error:', error.message);
            return null;
        }
    }

    guessPlatform(fileType, tags) {
        const ft = (fileType || '').toLowerCase();
        const t = (tags || []).map(x => x.toLowerCase());
        
        if (ft.includes('exe') || ft.includes('dll') || t.includes('exe')) return 'Windows';
        if (ft.includes('elf') || t.includes('elf') || t.includes('linux')) return 'Linux';
        if (ft.includes('apk') || t.includes('android')) return 'Android';
        if (ft.includes('macho') || t.includes('macos')) return 'macOS';
        if (t.includes('script') || ft.includes('script')) return 'Script';
        return 'Unknown';
    }
}

module.exports = new MalwareBazaarService();
